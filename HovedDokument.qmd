---
title: "Oppgave 1, MSB106-gruppe 1, 2026"
author: Amanda Wessel Skaar, Antonio Isa Jakobsen, Frida Alendal, Irjan Ananiassen Vikre, Ivan Stordal & Magnus Eidesmo 
editor: visual
csl: hvl_apa7_stil_bokmal_v1
lang: NO_nb

format:
  html:
    fig-cap-location: bottom
    fig-number: true
  pdf:
    documentclass: article
    number-sections: true
    keep-tex: true
    papersize: A4
    linestretch: 1.5
    mainfont: "Times New Roman"
    
execute:
  warning: false
  message: false
  error: false
  echo: false
  
bibliography: MSB104Assignments.bib (Skriv ny bib)
abstract: Skriv en abstract
keywords: ["regional utvikling", "sentralitet", "kommuner", "arbeidsledighet", "sysselsetting", "boligpriser", "flytting", "pendling"]
---

```{r}
#| label: setup
#| message: false
#| echo: true
#| warning: false
library(tidyverse)
library(readxl)
library(sf)
library(spdep)
library(writexl)
library(PxWebApiData)
library(modelsummary)
library(dplyr)
library(stringr)
library(writexl)
```

## Innledning

## Innhenting av data

### Folketall

### Demografisk data

### Sentralitetsindeksen for norske kommuner

```{r}
# Importerer og leser av excel-filene
sentralitet2020 <- 
  read_xlsx("sentralitet2020Kommuner.xlsx")

sentralitet2023_2024 <-
  read_xlsx("sentralitet_2023-2024_kommuner.xlsx")

# Sammenslåeing av tabellene sånn at vi kan se utvikling.
Sentralitet <- left_join(sentralitet2020, sentralitet2023_2024, by = c("Kommune" = "Kommune 2024"), keep = TRUE)
```

SSB bruker sentralitetsindeksen for å beskrive hvor sentralt en kommune ligger.
Dette blir målt gjennom hvor lett det er for innbyggerne å komme seg til viktige funksjoner.
Indeksen SSB bruker bygger på beregnet reisetid med bil fra bebodde område istedenfor liftlonjeavstand eller innbyggertall som kunne vært bedre.
Poenget for indeksen er å fange opp faktisk tilgjengelighet som er at kommunene regnes som mer sentrale hvis mange arbeidsplasser og ulike tjenestetilbud kan nås innenfor rimelig reisetid.

Indeksen består av to deler.
Den ene handler om hvor stort arbeidsmarked innbyggerne har innenfor en reiseramme (opptil 90 minutter), altså hvor mange arbeidsplasser som kan nås.
Den andre handler om tilgang til et bredt tjenestetilbud, som typisk er ulike typer varer og tjenester (for eksempel handel og offentlige tjenester).
I begge delene er det lagt opp til korte reiser teller mer enn lange reiser.
Det vil si at en arbeidsplass eller tjeneste i nærheten påvirker sentraliteten mer enn en som ligger langt unna.
Kommunens endelige verdi uttrykkes som en kontinuerlig indeks (høyere verdi = mer sentral), og verdiene kan også sorteres inn i seks sentralitetsklasser.

Når vi skulle se på 2017 indeksen så var det ikke direkte sammenlignbart med de senere årene, vi valgte derfor å heller ta år 2020 å sammenligne de med 2023-2024.
En grunn til dette i indeksen for 2017 kan være pågrunn av i denne perioden har det vært endringer i kommuneinndelingen (sammenslåinger og grensejusteringer), som kan påvirke hvilken samlet verdi en kommune får.
I tillegg ble det påpekt feil knyttet til deler av beregningen i den tidlige versjonen av indeksen, som senere er korrigert.

```{r}
# Dette er hentet med hjelp av ChatGPT
# Klargjør datasett for test
Sentralitet_test <- Sentralitet %>%
  filter(!is.na(`Indeks 2020`), !is.na(`Indeks 2023`)) %>%
  mutate(diff_20_23 = `Indeks 2023` - `Indeks 2020`)

# Her velger vi hva vi vil ha i tabellen
oppsummering <- Sentralitet_test %>%
  summarise(
    n = n(),
    mean_change = mean(diff_20_23),
    median_change = median(diff_20_23),
    sd_change = sd(diff_20_23),
    min_change = min(diff_20_23),
    max_change = max(diff_20_23)
  )

oppsummering

# Signifikans-test
test_t <- t.test(Sentralitet_test$diff_20_23, mu = 0)
```

Utifra t-testen finner vi ut at sentralitetsindeksen fra 2020 til 2023 har ikke så store endringer.
Vi har med 341 kommuner, og i gjennomsnitt har indeksen økt med ca.
2,8 poeng.
Medianen er 2 som betyr at for de fleste kommunene er endringen veldig liten.
Det er likevel noen kommuner som skiller seg ut, der den største nedgangen er -17 og den største økningen er 79.
Totalt sett tyder dette på at sentraliteten er ganske stabil i perioden, men med noen få unntak.
Alt i alt virker det som at sentralitetsmønsteret ikke har endret seg noe særlig, og at endringene heller handler om små oppdateringer enn store skift.

### Prosentvis arbeidsledighet

```{r}
options(encoding = "UTF-8")
Sys.setlocale("LC_CTYPE", "Norwegian")
```

#### SSB

```{r}
load("nor_knr24_vec.rdata")
load("newknr.rdata")
```

```{r}
Arb <- PxData12(
  "https://data.ssb.no/api/v0/no/table/13563/",
  Region = list("agg:KommSummer", knr24),
  Tid = as.character(2008:2024),
  HovArbStyrkStatus = c("A", "A.09"), 
  Alder = "15+",
  InnvandrKat = "A-G") |> 
select(region, år, HovArbStyrkStatus, value) |>
  pivot_wider(
    names_from  = HovArbStyrkStatus,
    values_from = value) |>
  rename(
    arbeidsstyrke = A,
    registrerte_ledige = `A.09`) |> 
 mutate(
    prosentvis_arbledig = if_else(
      is.na(arbeidsstyrke) | arbeidsstyrke == 0,
      NA_real_,
      100 * registrerte_ledige / arbeidsstyrke))
```

#### NAV

```{r}
# NA verdier har ikke blitt fjernet, hvis du lurte :)
# Leser inn excel tabell NavTabell.xlsx
NAV <- read_excel("NavTabell.xlsx",
                  sheet = 1,
                  skip = 4,
                  col_types = "text")

# Gjør om Karakterer til Nummeriske tall
NAV <- NAV |>
  mutate(
    År = as.numeric(År),
    Kommunenr = as.numeric(Kommunenr)
  )

NAV <- NAV |>
  mutate(
    beholdning = as.numeric(Beholdning),
    andel = as.numeric(`Andel av arbeidsstyrken`)
  ) |>
  filter(Kommunenr != -1)

# Lager et eget data for nav_aar, der en gjør om månedstall til ett gjennomsnittstall for hvert år i hver kommune.
nav_aar <- NAV |>
  group_by(Kommunenr, Kommunenavn, År) |>
  summarise(
    prosent_ledige_i_året = mean(andel, na.rm = TRUE),
    antall_ledige_i_året = mean(beholdning, na.rm = TRUE),
    .groups = "drop"
  )

# Sletter NAV grunnet til at de viktige tallene vi trenger ligger i nav_aar
 rm(NAV)
```

NAV og SSB (AKU) måler begge arbeidsledighet, men de gjør det på forksjellige måter.

NAV måler arbeidsledigheten utifra hvor mange som er registrert som helt arbeidsledige hos NAV.
Dataen til NAV bygger seg dermed opp på grunnlag av hvem som har meldt seg arbeidsledig i NAV-systemet.
NAV sine tall er avhengige av at arbeidsledige registrerte ledigeheten sin.
De blir og indirekte påvirket av hvilke regler som gjelder for å få hjelp (dagpenger) og at man må holde registreringen aktiv (fornye/holde registrering aktiv).

SSB sine tall kommer derimot fra AKU (Arbeidskraftundersøkelsen), som er en spørreundersøkelse der et utvalg av befolkningen blir intervjuet.
AKU måler arbeidsledigheten i hele befolkningen, Dette gjelder også personer som ikke er registrert hos NAV.
I AKU blir man regnet som arbeidsledig dersom man er uten jobb, har søkt jobb og er tilgjengelig for arbeid.

Begge disse statistikkene bygger på samme ide om hva arbeidsledighet er, men tallene kan bli forskjellige.
AKU fanger opp arbeidsledige som ikke melder seg hos NAV, og noen som er registrert hos NAV kan i AKU svare slik at de ikke blir klassifisert som arbeidsledige der.
I tillegg kan forskjeller i aldersavgrensning og tidspunktet det måles på bidra til at NAV- og AKU-tallene ikke blir like.

Kilde: <https://www.ssb.no/arbeid-og-lonn/sysselsetting/artikler/hvorfor-ulike-arbeidsledighetstall>

### Sysselsetting

### Gjennomsnittlig kvadratmeterpris for bolig

```{r}
gkmp <- read_excel("gkmp.xlsx")
spa  <- read_excel("spa.xlsx")
```

```{r}
gkmp <- gkmp %>%
  fill(Kommune, .direction = "down")

spa <- spa %>%
  fill(Kommune, .direction = "down")
```

```{r}
gkmp <- gkmp |>
  separate(
    Kommune,
    into = c("knr", "kommunenavn"),
    sep = " ",
    extra = "merge"
  )
```

```{r}
spa <- spa |>
  separate(
    Kommune,
    into = c("knr", "kommunenavn"),
    sep = " ",
    extra = "merge"
  ) |>
  fill(knr, kommunenavn, .direction = "down")
```

```{r}
gkmp <- gkmp |> mutate(knr = as.character(knr))
spa  <- spa  |> mutate(knr = as.character(knr))
spa <- spa %>%
  mutate(across(starts_with("20"), ~ as.numeric(.)))
```

```{r}
gkmp_long <- gkmp |> 
  pivot_longer(
    cols = starts_with("20"),  # velger alle år-kolonner (f.eks. 2002, 2003, ...)
    names_to = "år",
    values_to = "kvm_pris"
  ) |> 
  mutate(
    år = as.integer(år),
    knr = as.character(knr)
  )
```

```{r}
spa_long <- spa |> 
  pivot_longer(
    cols = starts_with("20"),  # år-kolonner også her
    names_to = "år",
    values_to = "antall"
  ) |> 
  mutate(
    år = as.integer(år),
    knr = as.character(knr)
  )
```

```{r}
bolig <- gkmp_long |> 
  left_join(spa_long, by = c("knr", "kommunenavn", "Boligtype", "år"))
```

```{r}
bolig <- bolig |> 
  mutate(
    kommunenavn_clean = kommunenavn |> 
      str_replace("\\s*[\\(\\d].*$", "") |> 
      str_trim()
  )
```

```{r}
bolig <- bolig |> 
  mutate(
    kvm_pris = ifelse(kvm_pris == ".", NA, kvm_pris),
    kvm_pris = as.numeric(kvm_pris),
    antall   = as.numeric(antall)
  )
```

```{r}
bolig_sammenslått <- bolig |> 
  group_by(kommunenavn_clean, år, Boligtype) |> 
  summarise(
    antall = sum(antall, na.rm = TRUE),
    kvm_pris = if_else(
      sum(antall, na.rm = TRUE) > 0,
      sum(kvm_pris * antall, na.rm = TRUE) / sum(antall, na.rm = TRUE),
      NA_real_
    ),
    .groups = "drop"
  )
```

```{r}
knr_nokkel <- bolig |> 
  group_by(kommunenavn_clean) |> 
  summarise(
    knr = max(as.numeric(knr), na.rm = TRUE),
    .groups = "drop"
  )
```

```{r}
bolig_sammenslått <- bolig_sammenslått |> 
  left_join(knr_nokkel, by = "kommunenavn_clean")
```

### Utdanningsnivå

```{r}
knr <- sort(unique(newknr$knr))
```

```{r}
utdanning <- pxwebData12(
    urlToData = "https://data.ssb.no/api/v0/no/table/09429/",
    Region = list("*"),
    Tid = as.character(c(1970, 1980:2024)),
    Nivaa = c("03a", "04a"),
    Kjonn = "0",
    ContentsCode = "Personer"
)
```

```{r}
utdanning <- utdanning |>
  rename(knr= Region) |> 
  left_join(newknr, join_by(knr)) |>
  filter(!is.na(knr2023)) |>
  group_by(knr2023, år) |>
  summarise(UH = sum(Personer), .groups = "drop") |>
  filter(knr2023 != "9999")
```

For å finne utdanningsnivå har vi brukt tabellen 09429.
Denne tabellen har ikke et datasett for nye kommuner per 2024.
Vi måtte derfor hente ut alle kommunene og så sortere etter de nye kommunenavnene ved å bruke "newknr".
Videre hentet vi ut data for begge kjønn og hentet ut bare høyere utdanning da vi så at det er det oppgaven krever.
Dataene var delt inn i "Universitets- og høgskolenivå, kort" og "Universitets- og høgskolenivå, lang", disse har vi slått sammen.
Vi har også filtrert vekk data for hele landet samlet.

### Ut- og innflytnninger pr 1000 innbyggere

```{r}
load("nor_knr24_vec.rdata")
load("newknr.rdata")
```

```{r}
knr <- sort(unique(newknr$knr))
```

```{r}
flytting <- pxwebData12(
  urlToData = "https://data.ssb.no/api/v0/no/table/13255/",
  Region = list("*"),
  Alder = c("18-29", "30+"),
  Tid = as.character(2010:2024)
  
)
```

```{r}
test <- flytting |>
  rename(knr= Region) |> 
  left_join(newknr, join_by(knr)) |>
  filter(!is.na(knr2023)) |>
  group_by(knr2023, år) |>
  filter(knr2023 != "9999")
```

```{r}
flytting_clean <- flytting %>%
  rename(knr = Region) %>%
  left_join(newknr, by = "knr", suffix = c("", "_map")) %>% 
  filter(!is.na(knr2023), knr2023 != "9999") %>%
  transmute(
    knr2023,
    kommune = region,
    år = Tid,
    alder = Alder,
    innflytting = Innflyttinger,
    utflytting  = Utflyttinger
  )

```

```{r}
flytting_clean <- flytting_clean %>%
  mutate(kommune = str_remove(kommune, "\\s*\\(.*\\)$"))
```

```{r}
beftot <- readRDS("beftot.rds")
befald <- readRDS("befald.rds")
bef    <- readRDS("bef.rds")

```

```{r}
# beftot: totalbefolkning (wide -> long)
beftot_long <- beftot %>%
  pivot_longer(
    cols = starts_with("bef"),
    names_to = "år",
    values_to = "bef_total"
  ) %>%
  mutate(år = as.integer(str_remove(år, "^bef"))) %>%
  filter(år >= 2010, år <= 2024) %>%
  mutate(kommunenummer = str_pad(as.character(kommunenummer), 4, pad = "0"))

# befald: aldersfordelt (wide -> long)
befald_long <- befald %>%
  pivot_longer(
    cols = starts_with("bef"),
    names_to = "år",
    values_to = "bef"
  ) %>%
  mutate(år = as.integer(str_remove(år, "^bef"))) %>%
  filter(år >= 2010, år <= 2024) %>%
  mutate(
    kommunenummer = str_pad(as.character(kommunenummer), 4, pad = "0"),
    alder = str_replace_all(alder, "–", "-")
  )
```

```{r}
# 0-9, 10-19, 20-29 for å bygge 18-29 og 30+
bef_nevner <- befald_long %>%
  filter(alder %in% c("0-9 år", "10-19 år", "20-29 år")) %>%
  select(kommunenummer, år, alder, bef) %>%
  pivot_wider(names_from = alder, values_from = bef) %>%
  left_join(beftot_long, by = c("kommunenummer", "år")) %>%
  mutate(
    bef_0_9   = `0-9 år`,
    bef_10_19 = `10-19 år`,
    bef_20_29 = `20-29 år`,
    # 18–29 ≈ 20–29 + 2/10 av 10–19 (18–19)
    bef_18_29 = bef_20_29 + 0.2 * bef_10_19,
    # 30+ = total - (0–29)
    bef_0_29 = bef_0_9 + bef_10_19 + bef_20_29,
    bef_30_pluss = bef_total - bef_0_29
  ) %>%
  select(kommunenummer, år, bef_total, bef_18_29, bef_30_pluss)

```

```{r}
# Sørger for at koder matcher (knr2023 er 4-sifret tekst)
flytting_clean2 <- flytting_clean %>%
  mutate(
    knr2023 = str_pad(as.character(knr2023), 4, pad = "0"),
    år = as.integer(år),
    alder = str_replace_all(as.character(alder), "–", "-")
  )

flytt_per1000 <- flytting_clean2 %>%
  left_join(
    bef_nevner,
    by = c("knr2023" = "kommunenummer", "år" = "år")
  ) %>%
  mutate(
    nevner = case_when(
      alder %in% c("18-29", "18-29 år") ~ bef_18_29,
      alder %in% c("30+", "30 år eller eldre", "30 år og over") ~ bef_30_pluss,
      TRUE ~ NA_real_
    ),
    inn_per_1000 = 1000 * innflytting / nevner,
    ut_per_1000  = 1000 * utflytting  / nevner
  )

```

```{r}
# 1) Utflytting per 1000 for 18–29
utflytting_18_29 <- flytt_per1000 %>%
  filter(alder %in% c("18-29", "18-29 år")) %>%
  transmute(
    knr2023, kommune, år,
    utflytting_18_29_per_1000 = ut_per_1000
  )

# 2) Innflytting per 1000 for 30+
innflytting_30plus <- flytt_per1000 %>%
  filter(alder %in% c("30+", "30 år eller eldre", "30 år og over")) %>%
  transmute(
    knr2023, kommune, år,
    innflytting_30pluss_per_1000 = inn_per_1000
  )

# 3) Netto-kategori (her: basert på 18+ siden vi har 18–29 og 30+)
netto_18pluss <- flytt_per1000 %>%
  filter(alder %in% c("18-29", "18-29 år", "30+", "30 år eller eldre", "30 år og over")) %>%
  group_by(knr2023, kommune, år) %>%
  summarise(
    inn = sum(innflytting, na.rm = TRUE),
    ut  = sum(utflytting,  na.rm = TRUE),
    .groups = "drop"
  ) %>%
  mutate(
    netto_antall_18pluss = inn - ut,
    netto_kategori_18pluss = case_when(
      netto_antall_18pluss > 0 ~ "Netto innflytting (18+)",
      netto_antall_18pluss < 0 ~ "Netto utflytting (18+)",
      TRUE ~ "Null"
    )
  )

# Samlet tabell
flytting_resultat <- netto_18pluss %>%
  left_join(utflytting_18_29, by = c("knr2023", "kommune", "år")) %>%
  left_join(innflytting_30plus, by = c("knr2023", "kommune", "år"))

```

### Inn- og utpendling

## Tilstand og utvikling for ulike variabler

## Korrelasjonsberegninger

## Sammenhengen mellom befolkning og sysselsetting

## Relevant hypoteser basert på deskriptiv statistikk

## En multippel regresjonsmodell for folketallsutvikling

## En multippel regresjonsmodell for sysselsettingsvekst

## Konklusjon og diskusjon

## Vedlegg

## Kildeliste
